<!DOCTYPE html>
<html>
<head>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <link rel="icon" href="images/shopping.png" />
    <link rel="stylesheet" href="Home.css" />
    <meta charset="utf-8" />
    <title>Store</title>
</head>
<body onload="onLoad()">

    <div id="ControlContainer">
        
        <span id="currentUser"></span>    
        <button id="logout" onclick="LogOut();">LogOut</button>
    </div>
    <h2 id="messages"></h2>
    <h1>
        Your Cart
    </h1>
    <table id="table">
        <thead>
            <tr>
                <th>
                    #
                </th>
                <th>
                    Name
                </th>
                <th>
                    Quanity
                </th>
                <th>
                    Price
                </th>
                <th>
                    Description
                </th>
            </tr>
        </thead>
    </table>
    <hr />
    <h3>Add an Item Here:</h3>
    <form id="form">

        <p>Name:</p>
        <input id="name" name="Name" type="text" required />
        <br />
        <p>Dezcription</p>
        <input id="description" name="Description" type="text" required />
        <br />
        <p>Quantity</p>
        <input id="quantity" name="Quantity" type="number" min="0" required />
        <br />
        <p>Cost</p>
        <input id="cost" name="Cost" type="number" min="0" required />
        <br />
        <input id="submit" type="submit" value="Add" />
    </form>
    <section id="imageSection">
    </section>
    <button id="logout" class="export">Export Data to Excel</button>
    <iframe id="txtArea1" style="display:none"></iframe>
    <iframe id="txtArea1" style="display:none"></iframe>
    <script>

        const url = "/api/Home"
        var numItems = 0;
        $("#form").submit(function (event) {

            event.preventDefault();

            var name = $("#name").val();
            var descrip = $("#description").val();
            var quant = $("#quantity").val();
            var cost = $("#cost").val();

            $.post(url + "/PostAdd/" + sessionStorage.getItem("usernamet2") + "&" + name + "&" + quant + "&" + cost + "&" + descrip, function (data) {
                console.log("add to list success");
            }).done(function done(data) {
                if (data === false) {

                    $("#messages").text("You Can Only Add Ten Items");
                    return;
                }
                $.getJSON(url + "/GetAll/" + sessionStorage.getItem("usernamet2"))
                    .done(function (data) {

                        if (data === true)
                            $("#messages").text("You Can Only Add Ten Items");
                        // On success, 'data' contains a list of products.
                        var i = 0;
                        $.each(data, function (key, item) {
                            if (i == numItems) {
                                $(`<tr id = ${i}>`).appendTo($('tbody'));
                                //, { text: item.name + "\t" + item.quantity + "\t" + item.cost + "\t" + item.description }
                                $('<td>', { text: key + 1 }).appendTo($(`#${i}`));
                                $('<td>', { text: item.name }).appendTo($(`#${i}`));
                                $('<td>', { text: item.quantity }).appendTo($(`#${i}`));
                                $('<td>', { text: "$" + item.cost }).appendTo($(`#${i}`));
                                $('<td>', { text: item.description }).appendTo($(`#${i}`));
                                $(`<td id = lastElement${i}>`).appendTo($(`#${i}`));
                                $(`<button id=${i}>X</button>`).appendTo($(`#lastElement${i}`));
                                $(`#lastElement${i} > button`).click(buttonHandler);
                                if (item.image != null) {
                                    $(`<img id = image${i}>`).appendTo($("#imageSection"));
                                    $(`#image${i}`).attr("src", item.image);
                                    $(`#image${i}`).css("width", "10%");
                                    $(`#image${i}`).css("height", "10%")
                                }
                            }
                            i++;
                        });
                        numItems = i;
                    });
            });
        });

        function onLoad() {

            $("#currentUser").text("Hello, " + sessionStorage.getItem("usernamet2") + "!");

            $.get("/api/Login/CanAccess/" + sessionStorage.getItem("usernamet2"), function (data) {
            }).done(function (data) {
                if (data === false) {
                    window.location.replace("/index.html");
                    return;
                }
            });

            var tenant = sessionStorage.getItem("tenant");
            if (tenant === "both") {
                $("<button id=\"logout\" class=\"ToOldUIB\">").appendTo("#ControlContainer");
                $(".ToOldUIB").text("Tenant2");
                $(".ToOldUIB").click(changeTenant);
            }

            $("<tbody>").appendTo($("#table"));
            $.get(url + "/GetAll/" + sessionStorage.getItem("usernamet2"))
                .done(function (data) {
                    var i = 0;
                    // On success, 'data' contains a list of products.
                    $.each(data, function (key, item) {
                        $(`<tr id = ${i}>`).appendTo($('tbody'));
                        //, { text: item.name + "\t" + item.quantity + "\t" + item.cost + "\t" + item.description }
                        $('<td>', { text: key + 1 }).appendTo($(`#${i}`));
                        $('<td>', { text: item.name }).appendTo($(`#${i}`));
                        $('<td>', { text: item.quantity }).appendTo($(`#${i}`));
                        $('<td>', { text: "$" + item.cost }).appendTo($(`#${i}`));
                        $('<td>', { text: item.description }).appendTo($(`#${i}`))
                        $(`<td id = lastElement${i}>`).appendTo($(`#${i}`));
                        $(`<button id=${i}>X</button>`).appendTo($(`#lastElement${i}`));
                        $(`#lastElement${i} > button`).click(buttonHandler);
                        if (item.image != null) {
                            $(`<img id = image${i}>`).appendTo($("#imageSection"));
                            $(`#image${i}`).attr("src", item.image);
                            $(`#image${i}`).css("width", "10%");
                            $(`#image${i}`).css("height", "10%")
                        }
                        i++;
                    });
                    numItems = i;
                });
        }

        function changeTenant() {

            window.location.replace("/temp.html");
        }

        function buttonHandler() {
            $.get(url + "/GetRemove/" + sessionStorage.getItem("usernamet2") + "&" + `${this.id}`, function () {
            }).done(function (data) {

                if (data === false) {
                    alert("api error");
                    return;
                } else {
                    $("#messages").text("Success Item Removed");
                    $("#messages").css("background-color", "pink");
                    setTimeout(function () {
                        $("#messages").text("");
                        $("#messages").css("background-color", "yellow");
                        window.location.href = window.location;
                    }, 1000);
                }
            });
        }

        function LogOut() {
            var jqxhr = $.get("/api/Login/LogOut/" + sessionStorage.getItem("usernamet2"), function () {
            }).done(function (data) {

                $("#messages").text(jqxhr.getResponseHeader("message"));
                $("#messages").css("background-color", "pink");
                setTimeout(function () {
                    window.location = jqxhr.getResponseHeader("location");
                }, 1000);
                return;
            });
        }

        $(".export").click(function () {
            var tab_text = "<table border='2px'><tr bgcolor='#87AFC6'>";
            var textRange; var j = 0;
            tab = document.getElementById('table'); // id of table

            for (j = 0; j < tab.rows.length; j++) {
                tab_text = tab_text + tab.rows[j].innerHTML + "</tr>";
                tab_text = tab_text + "</tr>";
            }

            tab_text = tab_text + "</table>";
            tab_text = tab_text.replace(/<input[^>]*>|<\/input>/gi, ""); // reomves input params

            var ua = window.navigator.userAgent;
            var msie = ua.indexOf("MSIE ");

            if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))      // If Internet Explorer
            {
                txtArea1.document.open("txt/html", "replace");
                txtArea1.document.write(tab_text);
                txtArea1.document.close();
                txtArea1.focus();
                sa = txtArea1.document.execCommand("SaveAs", true, "groceries.xls");
            }
            else                 //other browser not tested on IE 11
                sa = window.open('data:application/vnd.ms-excel,' + encodeURIComponent(tab_text));

            return (sa);
        });
    </script>
</body>
</html>